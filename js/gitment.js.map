{"version":3,"sources":["../src/gitment.js"],"names":["scope","extendRenderer","instance","renderer","container","targetContainer","render","theme","defaultTheme","e","state","firstChild","replaceChild","appendChild","Gitment","localStorage","getItem","token","setItem","oauthUri","redirect_uri","oauth","window","location","href","oauthParams","Object","assign","stringify","options","useTheme","id","title","document","link","desc","labels","perPage","maxCommentHeight","user","userInfo","accessToken","JSON","parse","fromCache","removeItem","error","meta","comments","undefined","users","reactions","commentReactions","currentPage","query","code","client_id","client_secret","search","replacedUrl","origin","pathname","hash","history","replaceState","isLoggingIn","post","then","data","access_token","update","catch","alert","addKeyPressListener","createIssue","loadComments","self","getElementById","addEventListener","target","nodeName","toUpperCase","content","value","length","substring","console","log","renderers","keys","forEach","Promise","all","loadMeta","loadUserInfo","loadCommentReactions","loadReactions","text","mode","owner","repo","concat","body","resolve","getIssue","issue","comments_url","pageCount","Math","ceil","push","get","creator","issues","reject","page","per_page","logout","total_count","url","comentReactions","map","comment","index","reactionsArray","login","author_association","loginLink","number","reaction","heart","findIndex","delete","splice","commentId","find","module","exports"],"mappings":"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","file":"gitment.js","sourcesContent":["import { autorun, observable } from 'mobx'\n\nimport { LS_ACCESS_TOKEN_KEY, LS_USER_KEY, NOT_INITIALIZED_ERROR } from './constants'\nimport { getTargetContainer, http, Query } from './utils'\nimport defaultTheme from './theme/default'\n\nconst scope = 'public_repo'\n\nfunction extendRenderer(instance, renderer) {\n  instance[renderer] = (container) => {\n    const targetContainer = getTargetContainer(container)\n    const render = instance.theme[renderer] || instance.defaultTheme[renderer]\n\n    autorun(() => {\n      const e = render(instance.state, instance)\n      if (targetContainer.firstChild) {\n        targetContainer.replaceChild(e, targetContainer.firstChild)\n      } else {\n        targetContainer.appendChild(e)\n      }\n    })\n\n    return targetContainer\n  }\n}\n\nclass Gitment {\n  get accessToken() {\n    return localStorage.getItem(LS_ACCESS_TOKEN_KEY)\n  }\n  set accessToken(token) {\n    localStorage.setItem(LS_ACCESS_TOKEN_KEY, token)\n  }\n\n  get loginLink() {\n    const oauthUri = 'https://github.com/login/oauth/authorize'\n    const redirect_uri = this.oauth.redirect_uri || window.location.href\n\n    const oauthParams = Object.assign({\n      scope,\n      redirect_uri,\n    }, this.oauth)\n\n    return `${oauthUri}${Query.stringify(oauthParams)}`\n  }\n\n  constructor(options = {}) {\n    this.defaultTheme = defaultTheme\n    this.useTheme(defaultTheme)\n\n    Object.assign(this, {\n      id: window.location.href,\n      title: window.document.title,\n      link: window.location.href,\n      desc: '',\n      labels: [],\n      theme: defaultTheme,\n      oauth: {},\n      perPage: 20,\n      maxCommentHeight: 250,\n    }, options)\n\n    this.useTheme(this.theme)\n\n    const user = {}\n    try {\n      const userInfo = localStorage.getItem(LS_USER_KEY)\n      if (this.accessToken && userInfo) {\n        Object.assign(user, JSON.parse(userInfo), {\n          fromCache: true,\n        })\n      }\n    } catch (e) {\n      localStorage.removeItem(LS_USER_KEY)\n    }\n\n    this.state = observable({\n      user,\n      error: null,\n      meta: {},\n      comments: undefined,\n      users: {},\n      reactions: [],\n      commentReactions: {},\n      currentPage: 1,\n    })\n\n    const query = Query.parse()\n    if (query.code) {\n      const { client_id, client_secret } = this.oauth\n      const code = query.code\n      delete query.code\n      const search = Query.stringify(query)\n      const replacedUrl = `${window.location.origin}${window.location.pathname}${search}${window.location.hash}`\n      history.replaceState({}, '', replacedUrl)\n\n      Object.assign(this, {\n        id: replacedUrl,\n        link: replacedUrl,\n      }, options)\n\n      this.state.user.isLoggingIn = true\n      http.post('https://gh-oauth.imsun.net', {\n          code,\n          client_id,\n          client_secret,\n        }, '')\n        .then(data => {\n          this.accessToken = data.access_token\n          this.update()\n        })\n        .catch(e => {\n          this.state.user.isLoggingIn = false\n          alert(e)\n        })\n    } else {\n      this.update()\n    }\n    this.addKeyPressListener()\n  }\n\n  init() {\n    return this.createIssue()\n      .then(() => this.loadComments())\n      .then(comments => {\n        this.state.error = null\n        return comments\n      })\n  }\n\n  addKeyPressListener() {\n    let self = this\n    // 获取父节点，并为它添加一个click事件\n    document.getElementById('container').addEventListener('keyup', function(e) {\n      // 检查事件源e.targe是否为Li\n      if(e.target && e.target.nodeName.toUpperCase() == \"TEXTAREA\") {\n        let content = e.target.value\n        if (content && content.length > 0) {\n          if (content.substring(content.length - 1) === '@') {\n            console.log(self.state.users)\n          }\n        }\n      }\n    })\n  }\n\n\n  useTheme(theme = {}) {\n    this.theme = theme\n\n    const renderers = Object.keys(this.theme)\n    renderers.forEach(renderer => extendRenderer(this, renderer))\n  }\n\n  update() {\n    return Promise.all([this.loadMeta(), this.loadUserInfo()])\n      .then(() => Promise.all([\n        this.loadComments().then(() => this.loadCommentReactions()),\n        this.loadReactions(),\n      ]))\n      .catch(e => this.state.error = e)\n  }\n\n  markdown(text) {\n    return http.post('/markdown', {\n      text,\n      mode: 'gfm',\n    })\n  }\n\n  createIssue() {\n    const { id, owner, repo, title, link, desc, labels } = this\n\n    return http.post(`/repos/${owner}/${repo}/issues`, {\n      title,\n      labels: labels.concat(['gitment', id]),\n      body: `${link}\\n\\n${desc}`,\n    })\n      .then((meta) => {\n        this.state.meta = meta\n        return meta\n      })\n  }\n\n  getIssue() {\n    if (this.state.meta.id) return Promise.resolve(this.state.meta)\n\n    return this.loadMeta()\n  }\n\n  post(body) {\n    return this.getIssue()\n      .then(issue => http.post(issue.comments_url, { body }, ''))\n      .then(data => {\n        this.state.meta.comments++\n        const pageCount = Math.ceil(this.state.meta.comments / this.perPage)\n        if (this.state.currentPage === pageCount) {\n          this.state.comments.push(data)\n        }\n        return data\n      })\n  }\n\n  loadMeta() {\n    const { id, owner, repo } = this\n    return http.get(`/repos/${owner}/${repo}/issues`, {\n        creator: owner,\n        labels: id,\n      })\n      .then(issues => {\n        if (!issues.length) return Promise.reject(NOT_INITIALIZED_ERROR)\n        this.state.meta = issues[0]\n        return issues[0]\n      })\n  }\n\n  loadComments(page = this.state.currentPage) {\n    let self = this\n    return this.getIssue()\n      .then(issue => http.get(issue.comments_url, { page, per_page: this.perPage }, ''))\n      .then((comments) => {\n        this.state.comments = comments\n        return comments\n      })\n  }\n\n  loadUserInfo() {\n    if (!this.accessToken) {\n      this.logout()\n      return Promise.resolve({})\n    }\n\n    return http.get('/user')\n      .then((user) => {\n        this.state.user = user\n        localStorage.setItem(LS_USER_KEY, JSON.stringify(user))\n        return user\n      })\n  }\n\n  loadReactions() {\n    if (!this.accessToken) {\n      this.state.reactions = []\n      return Promise.resolve([])\n    }\n\n    return this.getIssue()\n      .then((issue) => {\n        if (!issue.reactions.total_count) return []\n        return http.get(issue.reactions.url, {}, '')\n      })\n      .then((reactions) => {\n        this.state.reactions = reactions\n        return reactions\n      })\n  }\n\n  loadCommentReactions() {\n    if (!this.accessToken) {\n      this.state.commentReactions = {}\n      return Promise.resolve([])\n    }\n\n    const comments = this.state.comments\n    const comentReactions = {}\n    const users = {}\n\n    return Promise.all(comments.map((comment) => {\n      if (!comment.reactions.total_count) return []\n\n      const { owner, repo } = this\n      return http.get(`/repos/${owner}/${repo}/issues/comments/${comment.id}/reactions`, {})\n    }))\n      .then(reactionsArray => {\n        comments.forEach((comment, index) => {\n          comentReactions[comment.id] = reactionsArray[index]\n        })\n        comments.forEach(function (comment) {\n          users[comment.user.login] = comment.author_association != \"NONE\"\n        })\n        this.state.commentReactions = comentReactions\n        this.state.users = users\n\n        return comentReactions\n      })\n  }\n\n  login() {\n    window.location.href = this.loginLink\n  }\n\n  logout() {\n    localStorage.removeItem(LS_ACCESS_TOKEN_KEY)\n    localStorage.removeItem(LS_USER_KEY)\n    this.state.user = {}\n  }\n\n  goto(page) {\n    this.state.currentPage = page\n    this.state.comments = undefined\n    return this.loadComments(page)\n  }\n\n  like() {\n    if (!this.accessToken) {\n      alert('Login to Like')\n      return Promise.reject()\n    }\n\n    const { owner, repo } = this\n\n    return http.post(`/repos/${owner}/${repo}/issues/${this.state.meta.number}/reactions`, {\n      content: 'heart',\n    })\n      .then(reaction => {\n        this.state.reactions.push(reaction)\n        this.state.meta.reactions.heart++\n      })\n  }\n\n  unlike() {\n    if (!this.accessToken) return Promise.reject()\n\n\n    const { user, reactions } = this.state\n    const index = reactions.findIndex(reaction => reaction.user.login === user.login)\n    return http.delete(`/reactions/${reactions[index].id}`)\n      .then(() => {\n        reactions.splice(index, 1)\n        this.state.meta.reactions.heart--\n      })\n  }\n\n  likeAComment(commentId) {\n    if (!this.accessToken) {\n      alert('Login to Like')\n      return Promise.reject()\n    }\n\n    const { owner, repo } = this\n    const comment = this.state.comments.find(comment => comment.id === commentId)\n\n    return http.post(`/repos/${owner}/${repo}/issues/comments/${commentId}/reactions`, {\n      content: 'heart',\n    })\n      .then(reaction => {\n        this.state.commentReactions[commentId].push(reaction)\n        comment.reactions.heart++\n      })\n  }\n\n  unlikeAComment(commentId) {\n    if (!this.accessToken) return Promise.reject()\n\n    const reactions = this.state.commentReactions[commentId]\n    const comment = this.state.comments.find(comment => comment.id === commentId)\n    const { user } = this.state\n    const index = reactions.findIndex(reaction => reaction.user.login === user.login)\n\n    return http.delete(`/reactions/${reactions[index].id}`)\n      .then(() => {\n        reactions.splice(index, 1)\n        comment.reactions.heart--\n      })\n  }\n}\n\nmodule.exports = Gitment\n"]}